<!DOCTYPE html>  <html> <head>   <title>display.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="canvas.html">                 canvas.coffee               </a>                                           <a class="source" href="colors.html">                 colors.coffee               </a>                                           <a class="source" href="display.html">                 display.coffee               </a>                                           <a class="source" href="galactic.html">                 galactic.coffee               </a>                                           <a class="source" href="gradient.html">                 gradient.coffee               </a>                                           <a class="source" href="image.html">                 image.coffee               </a>                                           <a class="source" href="model.html">                 model.coffee               </a>                                           <a class="source" href="modeler.html">                 modeler.coffee               </a>                                           <a class="source" href="residual.html">                 residual.coffee               </a>                                           <a class="source" href="sersic.html">                 sersic.coffee               </a>                                           <a class="source" href="stretches.html">                 stretches.coffee               </a>                                           <a class="source" href="utils.html">                 utils.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               display.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>The Display class handles the displaying of grayscale image data, where each
pixel of the original image is stored as Float32 intensity value.
Using a chosen stretch (linear by default), the maps the original 
Float32 intensity values onto a 0-255 integer instensity space.
Then a with a chosen colormap (grayscale by default), the 0-255
integer intensity values are mapped into RBGA pixel values for display
on an HTML5 canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Canvas = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./canvas&#39;</span><span class="p">)</span>
<span class="nv">stretches = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./stretches&#39;</span><span class="p">)</span>
<span class="nv">colors = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./colors&#39;</span><span class="p">)</span>
<span class="nv">utils = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./utils&#39;</span><span class="p">)</span>
<span class="nv">Image = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;./image&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">Display</span> <span class="k">extends</span> <span class="nx">Canvas</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Initializes all the required information
and sets the width and height of the display.</p>

<p>The container is the div element the display will be
appended to.  The desiredWidth is the with of this display,
and the height will automatically be set to preserve the aspect ratio.
The image object must have width, height, and a data attribute.
See image.coffee for an example of an image class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">constructor: </span><span class="nf">(container,desiredWidth,image) -&gt;</span>
    <span class="vi">@image = </span><span class="k">new</span> <span class="nx">Image</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="nx">image</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
    <span class="vi">@image.data = </span><span class="nx">image</span><span class="p">.</span><span class="nx">data</span>
    <span class="vi">@min = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="vi">@max = </span><span class="nx">utils</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">image</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>

    <span class="nv">scaledWidth = </span><span class="o">~~</span><span class="nx">desiredWidth</span>
    <span class="vi">@scaleRatio = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">width</span><span class="o">/</span><span class="nx">scaledWidth</span>
    <span class="nv">scaledHeight = </span><span class="o">~~</span><span class="p">(</span><span class="nx">@image</span><span class="p">.</span><span class="nx">height</span><span class="o">/</span><span class="nx">@scaleRatio</span><span class="p">)</span>
    
    <span class="nx">@buildStretchBuffers</span><span class="p">()</span>
    <span class="nx">@buildColorBuffers</span><span class="p">()</span>
    
    <span class="vi">@stretch = </span><span class="nx">stretches</span><span class="p">.</span><span class="nx">linear</span>
    <span class="vi">@colormap = </span><span class="nx">colors</span><span class="p">.</span><span class="nx">grayscale</span>

    <span class="k">super</span> <span class="nx">container</span><span class="p">,</span><span class="nx">scaledWidth</span><span class="p">,</span><span class="nx">scaledHeight</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Sets the stretch used to display the image.
The actually stretch functions are stored
in stretches.coffee.  It will return true
if the stretch is availiable or false if
no stretch fucntion is found.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setStretch: </span><span class="nf">(stretch) -&gt;</span>
    <span class="k">switch</span> <span class="nx">stretch</span>
      <span class="k">when</span> <span class="s">&quot;linear&quot;</span>
        <span class="vi">@stretch = </span><span class="nx">stretches</span><span class="p">.</span><span class="nx">linear</span>
        <span class="kc">true</span>
      <span class="k">when</span> <span class="s">&quot;log&quot;</span>
        <span class="vi">@stretch = </span><span class="nx">stretches</span><span class="p">.</span><span class="nx">log</span>
        <span class="kc">true</span>
      <span class="k">when</span> <span class="s">&quot;power&quot;</span>
        <span class="vi">@stretch = </span><span class="nx">stretches</span><span class="p">.</span><span class="nx">power</span>
        <span class="kc">true</span>
      <span class="k">when</span> <span class="s">&quot;sqrt&quot;</span>
        <span class="vi">@stretch = </span><span class="nx">stretches</span><span class="p">.</span><span class="nx">sqrt</span>
        <span class="kc">true</span>
      <span class="k">when</span> <span class="s">&quot;arcsinh&quot;</span>
        <span class="vi">@stretch = </span><span class="nx">stretches</span><span class="p">.</span><span class="nx">arcsinh</span>
        <span class="kc">true</span>
      <span class="k">else</span> <span class="kc">false</span>

  </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Initializes the ArrayBuffer and Uint8ClampedArray used
to store the image data after it has been processed by
one of the stretch functions.  The values stored in this array
must be 0-255 integers, hence the 8-bit clamped array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildStretchBuffers: </span><span class="nf">-&gt;</span>
    <span class="vi">@stretchBuffer = </span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">@image</span><span class="p">.</span><span class="nx">width</span><span class="o">*</span><span class="nx">@image</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
    <span class="vi">@stretchView8 = </span><span class="k">new</span> <span class="nx">Uint8ClampedArray</span><span class="p">(</span><span class="nx">@stretchBuffer</span><span class="p">)</span>
    <span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Initilizes the ArrayBuffer for storing RBGA pixel data.
An 8-bit and 32-bit UintArray's are provided for the buffer.
The Uint8ClampedArray is provided for simpler usage; however,
the Uint32Array provides better performance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">buildColorBuffers: </span><span class="nf">-&gt;</span>
    <span class="vi">@colorBuffer = </span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">@image</span><span class="p">.</span><span class="nx">width</span><span class="o">*</span><span class="nx">@image</span><span class="p">.</span><span class="nx">height</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
    <span class="vi">@colorView8 = </span><span class="k">new</span> <span class="nx">Uint8ClampedArray</span><span class="p">(</span><span class="nx">@colorBuffer</span><span class="p">)</span>
    <span class="vi">@colorView32 = </span><span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">@colorBuffer</span><span class="p">)</span>
    <span class="kc">undefined</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Handles the processing of the image data into the required
form for display on a canvas.  It calls the stretch function,
colormap function, and scales the data using a nearest-neighbor
algorithm to fit the size of the canvas.  Also, the y-axis is flipped
to accomadate the origin location on the HTML5 canvas.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">processImage: </span><span class="nf">-&gt;</span>
    <span class="nv">stretchView = </span><span class="nx">@stretchView8</span>
    <span class="nv">colorView = </span><span class="nx">@colorView32</span>
    <span class="nv">canvasView = </span><span class="nx">@canvasView32</span>

    <span class="nx">@stretch</span><span class="p">(</span><span class="nx">@image</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span><span class="nx">stretchView</span><span class="p">,</span><span class="nx">@min</span><span class="p">,</span><span class="nx">@max</span><span class="p">)</span>
    <span class="nx">@colormap</span><span class="p">(</span><span class="nx">stretchView</span><span class="p">,</span><span class="nx">colorView</span><span class="p">)</span>
    
    <span class="nv">height = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">height</span>
    <span class="nv">width = </span><span class="nx">@image</span><span class="p">.</span><span class="nx">width</span>
    <span class="nv">invertCoeff = </span><span class="p">(</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nx">width</span>
    <span class="nv">scaleRatio = </span><span class="nx">@scaleRatio</span>
    <span class="nv">canvasWidth = </span><span class="nx">@canvasWidth</span>
    <span class="nv">canvasHeight = </span><span class="nx">@canvasHeight</span>

    <span class="nv">x = </span><span class="nx">canvasWidth</span>
    <span class="k">while</span> <span class="nx">x</span><span class="o">--</span>
      <span class="nv">coeff = </span><span class="o">~~</span><span class="p">(</span><span class="nx">x</span><span class="o">*</span><span class="nx">scaleRatio</span><span class="p">)</span> <span class="o">+</span> <span class="nx">invertCoeff</span>
      <span class="nv">y = </span><span class="nx">canvasHeight</span>
      <span class="k">while</span> <span class="nx">y</span><span class="o">--</span>
        <span class="nx">canvasView</span><span class="p">[(</span><span class="nx">canvasWidth</span><span class="o">*</span><span class="nx">y</span><span class="p">)</span><span class="o">+</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">colorView</span><span class="p">[</span><span class="nx">coeff</span> <span class="o">-</span> <span class="p">(</span><span class="o">~~</span><span class="p">(</span><span class="nx">y</span><span class="o">*</span><span class="nx">scaleRatio</span><span class="p">))</span><span class="o">*</span><span class="nx">width</span><span class="p">]</span>
    <span class="kc">undefined</span>
    
<span class="nx">module</span><span class="o">?</span><span class="p">.</span><span class="nv">exports = </span><span class="nx">Display</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 